# 修改计划文档

## 修改目标
在 `ControlFlowTypeChecker` 类中实现对控制流语句（`return`、`break`、`continue`）的类型检查逻辑，确保：
1. 正确处理控制流语句对块表达式类型的影响。
2. 标记控制流语句后的代码为不可达。
3. 确保类型推导的正确性，特别是 `NeverType` 和 `UnitType` 的处理。

---

## 修改内容

### 1. **`return` 语句的处理**
- **目标**：
  - 确保 `return` 语句的类型为 `NeverType`。
  - 验证 `return` 的返回值类型是否与函数的返回类型兼容。
  - 标记当前上下文及所有嵌套上下文为不可达。
- **修改点**：
  - 在 `visit(ReturnExprNode)` 方法中：
    - 检查 `return` 的值类型是否与函数返回类型匹配。
    - 如果匹配失败，抛出语义错误。
    - 将 `return` 的类型设置为 `NeverType`。
    - 遍历上下文栈，标记所有上下文为不可达。

---

### 2. **`break` 语句的处理**
- **目标**：
  - 确保 `break` 语句只能在循环上下文中使用。
  - 收集 `break` 的值类型，并存储在循环上下文中。
  - 将 `break` 的类型设置为 `NeverType`。
  - 标记当前上下文为不可达。
- **修改点**：
  - 在 `visit(BreakExprNode)` 方法中：
    - 查找最近的循环上下文。
    - 如果不存在循环上下文，抛出语义错误。
    - 检查 `break` 的值类型，并将其存储到循环上下文的 `breakTypes` 列表中。
    - 将 `break` 的类型设置为 `NeverType`。
    - 标记当前上下文为不可达。

---

### 3. **`continue` 语句的处理**
- **目标**：
  - 确保 `continue` 语句只能在循环上下文中使用。
  - 将 `continue` 的类型设置为 `NeverType`。
  - 标记当前上下文为不可达。
- **修改点**：
  - 在 `visit(ContinueExprNode)` 方法中：
    - 查找最近的循环上下文。
    - 如果不存在循环上下文，抛出语义错误。
    - 将 `continue` 的类型设置为 `NeverType`。
    - 标记当前上下文为不可达。

---

### 4. **块表达式的类型推导**
- **目标**：
  - 确保块表达式的类型由最后一条语句决定。
  - 如果最后一条语句是控制流语句（如 `return`、`break`、`continue`），则块的类型为 `NeverType`。
  - 确保中间语句（非最后一条语句）的类型为 `UnitType`，除非它们是 `NeverType`。
- **修改点**：
  - 在 `visit(BlockExprNode)` 方法中：
    - 遍历块中的所有语句。
    - 检查中间语句的类型是否为 `UnitType`，否则抛出语义错误。
    - 根据最后一条语句的类型设置块的类型。
    - 如果最后一条语句是控制流语句，设置块的类型为 `NeverType`。

---

### 5. **不可达代码的处理**
- **目标**：
  - 确保在控制流语句（`return`、`break`、`continue`）之后的代码被标记为不可达。
  - 在上下文中传播 `hasUnreachableCode` 标志。
- **修改点**：
  - 在所有控制流语句的处理逻辑中：
    - 标记当前上下文为不可达。
    - 在块表达式中，检查是否存在不可达代码，并抛出语义错误。

---

## 修改方法清单
以下方法将被修改或新增：
1. **`visit(ReturnExprNode)`**：
   - 实现 `return` 语句的类型检查逻辑。
2. **`visit(BreakExprNode)`**：
   - 实现 `break` 语句的类型检查逻辑。
3. **`visit(ContinueExprNode)`**：
   - 实现 `continue` 语句的类型检查逻辑。
4. **`visit(BlockExprNode)`**：
   - 实现块表达式的类型推导逻辑。
5. **`determineLoopType`**：
   - 确保循环的类型由所有 `break` 的值类型决定。

---

## 测试计划
1. **测试用例清单**：
   - 包含 `return` 的块表达式。
   - 包含 `break` 和 `continue` 的循环。
   - 嵌套控制流语句（如循环中的 `return` 或 `break`）。
   - 不可达代码的检测。
2. **测试目标**：
   - 确保类型推导正确。
   - 确保语义错误被正确抛出。
   - 确保不可达代码被正确标记。